---
description: 生成 SDD-lite 场景 JS（先采访澄清需求；用户 OK 后再产出；模块自治 + 可复现 + 可清理）
---

用户调用方式：
/sdd <模块路径...> <场景需求描述>

用户输入参数：$ARGUMENTS

## 参数解析（必须按此处理）

* $ARGUMENTS 由两部分组成：

  1. 模块路径列表：一个或多个路径（文件/目录）
  2. 场景需求：一段自然语言描述（例如“打开页面点击开始后 mock 排名接口，出现追赶反超效果”）
* 分隔规则（简单可靠）：

  * 如果参数中出现 `--`，则：

    * `--` 前面全部当作模块路径（空格分隔，允许用引号包裹含空格路径）
    * `--` 后面全部当作场景需求
    * 示例：/sdd "src/views/horse ahead" src/api/horseAhead -- 打开页面后点击开始，模拟接口返回追赶反超
  * 如果没有 `--`，则：

    * 尝试从左到右把 token 解析为“存在的路径”（文件或目录）
    * 一旦遇到第一个“不是有效路径”的 token，从该 token 开始到末尾都当作场景需求
    * 若全部 token 都是有效路径，则场景需求为空（此时写“未提供具体场景需求”）

## 目标

基于给定模块路径与场景需求，生成一份可运行的 **SDD-lite 场景 JS**（以及必要的模块内 helper/mock 文件），用于**人工验证** UI 行为与“竞技效果”。

## 生成范围（要克制）

* 只生成与该场景直接相关的最小文件集合：

  * 必需：`<module>/__sdd__/scenarios/*.scenario.js`
  * 可选：`<module>/__sdd__/helpers/*`、`<module>/__sdd__/mocks/*`（仅当需要复用或隔离复杂 mock 逻辑时）
* 禁止把业务相关 helper/mock 放到 `src/__sdd__/`（全局目录只能放 runtime/boot/discover 等基础设施）

## 强约束（必须遵守）

1. **模块自治**：helpers/mocks/scenarios 必须放在 `<module>/__sdd__/` 下
2. **场景结构固定**：场景文件必须 `export default { id, title, note?, setup({ runtime, options }) }`
3. **清理机制优先级最高**：任何副作用（patch request/store、timer、事件监听、缓存等）必须用 `runtime.onReset(fn)` 登记清理；切场景会先 resetEnv
4. **不写测试断言**：以“人工验证步骤 + 可观察输出”为主；把验证点写在 `note`
5. **可复现**：mock 数据与时序必须固定（不要随机）；若需要可配置，用 options 明确默认值
6. **不猜实现细节**：当你无法看到模块代码、接口定义、action 名、url、响应结构时，必须向用户索要：文件内容/关键片段/行号范围（不要臆测）

## 工作流（严格执行）

你必须按两个阶段工作：先采访，再生成。

### 阶段 A：采访澄清（只输出问题，不写代码）

你需要把“模糊需求”收敛成“可执行的拦截点 + 数据结构 + 时序 + 可观察信号”。

输出内容必须包含以下三块（顺序固定）：

1. **问题清单（每轮最多 7 个）**

   * 按优先级从高到低提问
   * 每个问题必须具体到能落地（例如 method/url/参数/返回字段、action 名、轮询间隔、UI 可观察信号）
2. **已确认信息表（持续更新）**

   * 模块入口/页面路径
   * 用户动作链路（打开 → 点击 → …）
   * 需要 mock 的接口/action 清单（若已确认）
   * “竞技效果”的可观察定义（若已确认）
   * options（若已确认）
3. **未决信息表（持续更新）**

   * 明确列出你仍缺的关键信息

采访循环规则：

* 你必须持续采访，直到关键信息全部明确
* 当你判断信息已经足够，你只能输出一句收敛语：

  * “如果确认无误请回复 OK；回复 OK 后我将开始生成场景代码”
* 在用户回复 **OK** 之前，你绝对不能开始写任何场景 JS 代码（包括伪代码）

### 阶段 B：生成代码（仅在用户回复 OK 后）

你必须输出以下内容（顺序固定）：

1. **场景方案摘要（短）**

   * 选择的拦截点：`request.*` / `store.dispatch` / 其它（说明理由）
   * mock 的 url/action 列表
   * 数据结构要点（响应字段、关键计算）
   * 时序设计（tick/轮询/延迟/阶段切换）
2. **代码输出（必须是代码块，并标注文件路径）**

   * 主场景文件：`<module>/__sdd__/scenarios/<name>.scenario.js`
   * 如需额外 helper/mock：必须放在 `<module>/__sdd__/helpers/*` 或 `<module>/__sdd__/mocks/*`
   * 所有 patch/timer/状态必须通过 `runtime.onReset` 恢复与清理（包括 tick 归零、恢复原函数）
3. **note 内容要求（必须写在场景对象里）**

   * 目标：这个场景要验证什么
   * 使用方式：如何运行（`window.SDD.run("<id>", options)`）
   * 人工验证点：至少 3 条（含“竞技效果”的可观察信号）
   * options 说明：有哪些参数、默认值、边界值建议

## 采访问题库（优先级模板：按需抽取，别一次问完）

A. 入口与链路

* 模块入口文件里，“打开页面 → 点击开始游戏”对应的组件/方法/事件名是什么？请贴相关代码片段
* 场景覆盖到哪一步为止：只到对局中排名变化？还是包含结算页/弹窗？

B. API / Action 拦截点（必须明确）

* 需要 mock 哪些请求：method、url path、关键 params/body、返回结构示例（至少贴一份真实响应或字段表）
* 请求层用哪个模块（例如 request 封装路径）？适合 patch `request.get/post` 还是拦截 `store.dispatch`？
* 是一次性请求还是轮询？轮询间隔与触发条件是什么？

C. “竞技效果”的可观察定义（把“感觉”变成“实现”）

* 你希望 UI 具体看到哪些变化？（例：名次从 5→1、某条高亮、进度条追赶、动画触发）
* 玩家数量、主角是谁、名次/分数变化曲线期望（至少给出 5~10 个 tick 的变化规则）

D. options 与边界

* 需要哪些 options（例：playersCount、tickCount、delayMs、mode）？默认值是什么？
* 需要手动验证哪些边界（例：人数 2/10/50、延迟 0/1000ms）？

E. 清理与隔离

* 场景运行后是否需要自动跳转路由/自动点击？还是只提供数据环境用户自行操作？
* 有哪些副作用必须清：store 状态、缓存、timer、事件监听、patch？

## 输出要求

* 阶段 A：只输出“问题清单 + 已确认信息表 + 未决信息表”，不要输出任何代码块
* 阶段 B：必须输出代码块，并在代码块上方标注文件路径
* 若模块路径不存在：在已确认信息表里标注“未找到”，继续对其它可用路径推进（不要中断）
* 永远不要输出与任务无关的解释性长文

现在开始：解析 $ARGUMENTS，进入【阶段 A：采访澄清】。
